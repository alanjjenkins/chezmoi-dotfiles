# {{{ Enable Powerlevel10k instant prompt.
# Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block, everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi
# }}}
# {{{ SSH agent
if [ -z "$SSH_AUTH_SOCK" ];
then
    export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/ssh-agent.socket"
fi
# }}}
# {{{ Aliases
# {{{ Easier navigation
## .., ..., ...., ....., and -
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias .....="cd ../../../.."
alias -- -="cd -"

alias cdd="cd ~/Downloads/"
alias cdg="cd ~/git/"
alias cdot="chezmoi cd"
alias cdgo="cd \$GOPATH"
# }}}
# {{{ Archlinux specific aliases
alias makepkg='chrt --idle 0 ionice -c idle makepkg'
# }}}
# {{{ Misc
alias ewm='cd ~/git/ewmg'
alias fpm='podman run --rm -v "${WORKSPACE}:/source" -v /etc/passwd:/etc/passwd:ro --user=$(id -u):$(id -g) claranet/fpm'
alias jctlw='sudo journalctl -u wpa_supplicant@wlp58s0'
alias key='ssh-add ~/git/ssh_keys/id_bashton_alan'
alias keyaur="ssh-add ~/git/ssh_keys/id_aur"
alias keyb='ssh-add ~/git/ssh_keys/id_bashton'
alias keycl='ssh-add -D'
alias keyp='ssh-add ~/git/ssh_keys/id_personal'
alias keypa='ssh-add ~/git/ssh_keys/id_alan-aws'
alias keypo='ssh-add ~/git/ssh_keys/id_personal_old'
alias kmse='export EYAML_CONFIG=$PWD/.kms-eyaml.yaml'
# alias sleep="i3lock && sudo systemctl suspend"
alias snowrep='~/git/bashton-servicenow/reports.py'
alias snowtick='~/git/bashton-servicenow/view-ticket.py --nobox'
alias tw='task +work'
alias tp='task +personal'
alias vim='nvim'
alias vi='nvim'
alias gpu-on='sudo tee /proc/acpi/bbswitch <<<ON'
alias gpu-off='sudo tee /proc/acpi/bbswitch <<<OFF'

if uname -a | grep 'Darwin' &> /dev/null; then
  alias ll='ls -G';
  alias ls='ls -G';
else
  alias ll='exa -l --grid --git';
  alias ls='exa';
  alias lt='exa --tree --git --long';
fi
# }}}
# }}}
# {{{ Environment variables
export ARDUINO_PATH='/usr/share/arduino'
export AWS_DEFAULT_REGION='eu-west-1'
export EDITOR='vim'
export GOPATH="/home/$USER/go"
export HISTCONTROL=ignoredups:ignorespace
export HOMEBREW_CASK_OPTS='--appdir=/Applications'
export PATH="$PATH:/usr/local/sbin"
export PATH="$PATH:/home/$USER/go/bin"
export PATH="$PATH:/home/$USER/bin"
export PATH="$PATH:/home/$USER/.local/bin"
export PATH="$PATH:/home/$USER/.gem/ruby/2.7.0/bin"
export PATH="$PATH:/home/$USER/.gem/ruby/2.6.0/bin"
export PATH="$PATH:/home/$USER/.gem/ruby/2.5.0/bin"
export PATH="$PATH:/home/$USER/.gem/ruby/2.4.0/bin"
export PATH="$PATH:/home/$USER/.asdf/installs/ruby/truffleruby-19.2.0/bin"
# }}}
# {{{ ZSH Options
KEYTIMEOUT=1
# }}}

export ZPLUG_HOME="$HOME/.local/share/zplug"
if [ ! -e "$ZPLUG_HOME" ]; then
  git clone https://github.com/zplug/zplug "$ZPLUG_HOME"
fi

source "$ZPLUG_HOME/init.zsh"

# Install plugins if there are plugins that have not been installed
if ! zplug check --verbose; then
    printf "Install? [y/N]: "
    if read -q; then
        echo; zplug install
    fi
fi

zplug "Dbz/kube-aliases"
zplug "alanjjenkins/assume-role-1"
zplug "alanjjenkins/zsh-my-aws"
zplug "chriskempson/base16-shell"
zplug "fabiokiatkowski/exercism.plugin.zsh"
zplug "hschne/fzf-git"
zplug "joepvd/zsh-hints"
zplug "kiurchv/asdf.plugin.zsh", defer:2
zplug "macunha1/zsh-terraform"
zplug "marzocchi/zsh-notify"
zplug "molovo/tipz"
zplug "plugins/aws",   from:oh-my-zsh
zplug "qoomon/zsh-lazyload"
zplug "romkatv/powerlevel10k", as:theme, depth:1
zplug "softmoth/zsh-vim-mode"
zplug "unixorn/kubectx-zshplugin"
zplug "zsh-users/zsh-completions"

# if command -v fasd &> /dev/null; then
#   if command -v fzf &> /dev/null; then
zplug "wookayin/fzf-fasd"
  # fi
# fi

# zplug "tevren/gitfast-zsh-plugin"
# zplug "hschne/fzf-git"

# Then, source plugins and add commands to $PATH
zplug load

# plugins=(
#   # assume-role
#   # command-not-found
#   adb
#   alias-finder
#   ansible
#   archlinux
#   asdf
#   autopep8
#   aws
#   battery
#   bgnotify
#   colorize
#   docker
#   docker-compose
#   dotenv
#   fzf
#   git
#   git-auto-fetch
#   git-extras
#   git-prompt
#   gitfast
#   golang
#   gpg-agent
#   jsontools
#   kube-ps1
#   kubectl
#   man
#   minikube
#   nmap
#   node
#   npm
#   pass
#   pep8
#   python
#   ripgrep
#   ssh-agent
#   sudo
#   systemd
#   terraform
#   tig
#   vi-mode
#   yarn
# )

autoload bashcompinit
bashcompinit

# {{{ Source existing files bash helpers
SOURCE_FILES=(
    # "$HOME/git/bashton-my-aws/functions"
    "$HOME/git/bashton-sshuttle/sshuttle-vpn"
    "$HOME/puppet-log-reader/bash-functions.sh"
    /usr/share/doc/pkgfile/command-not-found.bash
)

for FILE in "${SOURCE_FILES[@]}";
do
    if [ -e "$FILE" ];
    then
        source "$FILE"
    fi
done
# }}}
# {{{ ranger cd
function rcd {
    # create a temp file and store the name
    tempfile="$(mktemp -t tmp.XXXXXX)"

    # run ranger and ask it to output the last path into the
    # temp file
    ranger --choosedir="$tempfile" "${@:-$(pwd)}"

    # if the temp file exists read and the content of the temp
    # file was not equal to the current path
    test -f "$tempfile" &&
    if [ "$(cat -- "$tempfile")" != "$(echo -n `pwd`)" ]; then
        # change directory to the path in the temp file
        cd -- "$(cat "$tempfile")"
    fi

    # its not super necessary to have this line for deleting
    # the temp file since Linux should handle it on the next
    # boot
    rm -f -- "$tempfile"
}
# }}}

if ! command -v assume-role &>/dev/null; then
  go get -u github.com/alanjjenkins/assume-role
fi

# Vi mode
set -o vi

# ===== Basics
setopt no_beep # don't beep on error
setopt interactive_comments # Allow comments even in interactive shells (especially for Muness)

# ===== Changing Directories
setopt auto_cd # If you type foo, and it isn't a command, and it is a directory in your cdpath, go there
setopt cdablevarS # if argument to cd is the name of a parameter whose value is a valid directory, it will become the current directory
setopt pushd_ignore_dups # don't push multiple copies of the same directory onto the directory stack

# ===== Expansion and Globbing
setopt extended_glob # treat #, ~, and ^ as part of patterns for filename generation

# ===== History
setopt append_history # Allow multiple terminal sessions to all append to one zsh command history
setopt extended_history # save timestamp of command and duration
setopt inc_append_history # Add comamnds as they are typed, don't wait until shell exit
setopt hist_expire_dups_first # when trimming history, lose oldest duplicates first
setopt hist_ignore_dups # Do not write events to history that are duplicates of previous events
setopt hist_ignore_space # remove command line from history list when first character on the line is a space
setopt hist_find_no_dups # When searching history don't display results already cycled through twice
setopt hist_reduce_blanks # Remove extra blanks from each command line being added to history
setopt hist_verify # don't execute, just expand history
setopt share_history # imports new commands and appends typed commands to history

# ===== Completion
setopt always_to_end # When completing from the middle of a word, move the cursor to the end of the word
setopt auto_menu # show completion menu on successive tab press. needs unsetop menu_complete to work
setopt auto_name_dirs # any parameter that is set to the absolute name of a directory immediately becomes a name for that directory
setopt complete_in_word # Allow completion from within a word/phrase

unsetopt menu_complete # do not autoselect the first completion entry

# ===== Correction
unsetopt correct_all # spelling correction for arguments
setopt correct # spelling correction for commands

# ===== Prompt
setopt prompt_subst # Enable parameter expansion, command substitution, and arithmetic expansion in the prompt
# setopt transient_rprompt # only show the rprompt on the current prompt

# ===== Scripts and Functions
setopt multios # perform implicit tees or cats when multiple redirections are attempted

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
#POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(aws_assume_role)
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

(( $+commands[fasd] )) && eval "$(fasd --init auto)"
eval "$(direnv hook zsh)"
